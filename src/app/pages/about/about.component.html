<div class="about-wrapper">
  <!-- ========================= CORE (intro + partenaire) ========================= -->
  <section class="section core" *ngIf="core.length">
    <div class="section-inner px-0 pb-2">
      <h1 #coreTitle class="block-title prehide" *ngIf="core[0]?.title">
        {{ core[0].title }}
      </h1>

      <div #coreGrid class="core-grid px-0" [class.prehide]="!coreReady">
        <!-- Colonne gauche : texte intro -->
        <article #coreLeft class="core-block core-left">
          <div class="block-html" [innerHTML]="core[0].html"></div>
        </article>

        <!-- Colonne droite : partenaire (carrousel) -->
        <aside
          #coreRight
          class="core-block core-right partners"
          [class.is-empty]="!activePartner"
        >
          <article class="member-card p-0">
            <div class="photo-tile">
              <img
                [attr.src]="currentPhotoUrl || defaultPortrait"
                [attr.alt]="'Portrait de ' + (activePartner?.nameFirst || '') + ' ' + (activePartner?.nameLast || '')"
                loading="eager"
                fetchpriority="high"
                decoding="async"
                (error)="onImgError($event)"
              />
            </div>

            <div class="member-text pt-3">
              <div class="member-area">
                {{ activePartner?.area || ' ' }}
              </div>

              <div class="member-name">
                <div class="first">
                  {{ activePartner?.nameFirst || ' ' }}
                </div>
                <div class="last">
                  {{ activePartner?.nameLast || ' ' }}
                </div>
              </div>

              <!-- Badge organisme (RICS) : lien vers page Équipe -->
              <a
                *ngIf="currentOrgLogoUrl"
                class="member-org-link"
                [routerLink]="teamRouteLink()"
                [attr.aria-label]="isEnglish() ? 'View the team' : 'Voir l’équipe'"
              >
                <img
                  class="member-org-logo"
                  [attr.src]="currentOrgLogoUrl"
                  alt="RICS"
                  loading="lazy"
                  decoding="async"
                  (error)="onOrgImgError($event)"
                />
              </a>


              <div
                class="member-job"
                [innerHTML]="activePartner?.jobHtml || ''">
              </div>
            </div>
          </article>
        </aside>
      </div>
    </div>
  </section>

  <!-- ========================= MESH (maillage) ========================= -->
<section class="section mesh" *ngIf="mesh as ms">
  <div class="section-inner px-0 pt-7">
    <h2
      #meshTitleEl
      class="mesh-title mb-lg-5 mb-7 prehide"
      *ngIf="ms.title">
      {{ ms.title }}
    </h2>

    <div
      #meshSkylineEl
      class="mesh-skyline mt-5 prehide"
      *ngIf="ms.image">
      <img
        [appImgFast]="ms.image || ''"
        [placeholder]="'/assets/fallbacks/image-placeholder.svg'"
        loading="lazy"
        decoding="async"
        alt=""
        aria-hidden="true"
      />
    </div>

    <ul
      #meshLevelsEl
      class="mesh-levels prehide"
      *ngIf="ms.levels.length">
      <li
        #meshLevelEl
        class="prehide"
        *ngFor="let l of ms.levels; trackBy: trackByIndex">
        {{ l }}
      </li>
    </ul>
  </div>
</section>


<!-- ========================= MAP (Où ?) ========================= -->
<section class="section map-section" *ngIf="mapSection as ms">
  <div class="section-inner px-0">
    <div class="map-grid">
      <div #mapImageEl class="map-image prehide" *ngIf="ms.image">
        <img
          [appImgFast]="ms.image || ''"
          [placeholder]="'/assets/fallbacks/image-placeholder.svg'"
          loading="lazy"
          decoding="async"
          alt="Carte du Groupe ABC"
        />
      </div>

      <div class="map-list ps-lg-0 ps-5">
        <h2
          #mapTitleEl
          class="map-title prehide"
          *ngIf="ms.title">
          {{ ms.title }}
        </h2>

        <ul *ngIf="ms.items.length">
          <li
            #mapItem
            class="prehide-row map-item--clickable"
            *ngFor="let item of ms.items; trackBy: trackByIndex"
            tabindex="0"
            role="button"
            (click)="openRegion(item)"
            (keydown.enter)="openRegion(item)"
            (keydown.space)="openRegion(item)"
            [attr.aria-label]="'Voir l’équipe région ' + item"
          >
            {{ item }}
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- ========================= VALEURS ========================= -->
<section class="section values" *ngIf="coreValues.length">
  <div class="values-bg">
    <div class="values-layer active"></div>
  </div>
  <div class="section-inner">
    <h2
      #valuesTitleEl
      class="values-title prehide"
      *ngIf="coreValuesTitle">
      {{ coreValuesTitle }}
    </h2>

    <ul class="values-grid" role="list">
      <li
        #valueItemEl
        class="value-item prehide"
        *ngFor="let v of coreValues; index as i; trackBy: trackByIndex">
        <div class="icon-wrap">
          <img
            [appImgFast]="v.iconUrl || ''"
            [placeholder]="'/assets/fallbacks/image-placeholder.svg'"
            loading="lazy"
            decoding="async"
            alt=""
            aria-hidden="true"
          />
        </div>

        <h3 class="value-name" *ngIf="v.title">
          {{ v.title }}
        </h3>

        <div
          class="value-desc"
          *ngIf="v.html"
          [innerHTML]="v.html">
        </div>

        <span
          class="divider"
          *ngIf="i < coreValues.length - 1">
        </span>
      </li>
    </ul>
  </div>
</section>

<!-- ========================= AFFILIATIONS ========================= -->
<section class="section affiliations" *ngIf="affiliations.length">
  <div class="section-inner px-0">
    <h2
      #affTitleEl
      class="aff-title prehide"
      *ngIf="affTitle">
      {{ affTitle }}
    </h2>

    <ul class="aff-list" role="list">
      <li
        #affRowEl
        class="aff-row prehide-row py-2"
        *ngFor="let a of affiliations; let i = index; trackBy: trackByIndex"
        [class.open]="affOpen[i]"

        tabindex="0"
        role="button"
        [attr.aria-expanded]="affOpen[i] ? 'true' : 'false'"
        [attr.aria-controls]="'aff-desc-' + i"
        [attr.aria-label]="(affOpen[i] ? 'Réduire : ' : 'Déployer : ') + (a.excerpt || 'Appartenance')"

        (click)="toggleAff(i)"
        (keydown)="onRowToggleKeydown($event, i, 'aff')"
      >
        <div class="aff-line">
          <img
            class="aff-logo"
            *ngIf="a.logo"
            [src]="a.logo || ''"
            alt=""
            loading="lazy"
            decoding="async"
          />

          <div class="aff-name" *ngIf="a.excerpt as n">
            <span class="aff-abbr">{{ splitAffName(n).abbr }} :</span>
            <span class="aff-label">{{ splitAffName(n).label }}</span>
          </div>

          <!-- ✅ Le chevron continue de fonctionner, mais ne déclenche pas le click du <li> -->
          <button
            class="aff-toggle"
            type="button"
            [attr.aria-expanded]="affOpen[i] ? 'true':'false'"
            (click)="$event.stopPropagation(); toggleAff(i)"
          >
            <svg class="chevron" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <span class="sr-only">{{ affOpen[i] ? 'Réduire' : 'Déployer' }}</span>
          </button>
        </div>

        <div class="aff-desc" *ngIf="a.content && affOpen[i]" [attr.id]="'aff-desc-' + i">
          <div class="aff-desc-inner" [innerHTML]="a.content"></div>
        </div>
      </li>
    </ul>

  </div>
</section>


<!-- ========================= DEONTOLOGIE ========================= -->
<section class="section deon" *ngIf="deontology.length">
  <div class="section-inner px-0 pt-2">
    <h2 #deonTitleEl class="deon-title prehide" *ngIf="deonTitle">
      {{ deonTitle }}
    </h2>

    <ul class="deon-list" role="list">
      <li
        #deonRowEl
        class="deon-row prehide-row"
        *ngFor="let d of deontology; let i = index; trackBy: trackByIndex"
        [class.open]="deonOpen[i]"
        tabindex="0"
        role="button"
        [attr.aria-expanded]="deonOpen[i] ? 'true' : 'false'"
        [attr.aria-controls]="'deon-desc-' + i"
        [attr.aria-label]="(deonOpen[i] ? 'Réduire : ' : 'Déployer : ') + (d.title || 'Déontologie')"
        (click)="toggleDeon(i)"
        (keydown)="onRowToggleKeydown($event, i, 'deon')"
      >
        <div class="deon-line">
          <div class="deon-name">{{ d.title }}</div>

          <!-- ✅ IMPORTANT : ne pas toggler quand on clique le lien -->
          <a
            *ngIf="d.file"
            class="deon-dl deon-dl--inline"
            [attr.href]="d.file"
            [attr.download]="isSameOrigin(d.file) ? safeDownloadName(d.file) : null"
            [attr.target]="!isSameOrigin(d.file) ? '_blank' : null"
            [attr.rel]="!isSameOrigin(d.file) ? 'noopener' : null"
            [attr.aria-label]="deonDownloadAriaLabel(i, d)"
            (click)="$event.stopPropagation()"
            (keydown.enter)="$event.stopPropagation()"
            (keydown.space)="$event.stopPropagation()"
          >
            <img
              class="dl-icon-img"
              src="assets/icons/download.webp"
              alt=""
              width="35"
              height="46"
              loading="lazy"
            />
            <span class="dl-label">{{ deonDownloadLabel(i, d) }}</span>
          </a>

          <!-- ✅ Chevron ok, sans bubble -->
          <button
            class="deon-toggle"
            type="button"
            [attr.aria-expanded]="deonOpen[i] ? 'true' : 'false'"
            (click)="$event.stopPropagation(); toggleDeon(i)"
          >
            <svg class="chevron" viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M6 9l6 6 6-6"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
            <span class="sr-only">
              {{ deonOpen[i] ? 'Réduire le texte de déontologie' : 'Afficher le texte de déontologie' }}
            </span>
          </button>
        </div>

        <div
          class="deon-desc"
          *ngIf="d.html && deonOpen[i]"
          [attr.id]="'deon-desc-' + i"
        >
          <div class="deon-desc-inner pe-5" [innerHTML]="d.html"></div>

          <!-- ✅ pareil: clic sur lien n’ouvre/ferme pas la ligne -->
          <a
            *ngIf="d.file"
            class="deon-dl deon-dl--below"
            [attr.href]="d.file"
            [attr.download]="isSameOrigin(d.file) ? safeDownloadName(d.file) : null"
            [attr.target]="!isSameOrigin(d.file) ? '_blank' : null"
            [attr.rel]="!isSameOrigin(d.file) ? 'noopener' : null"
            [attr.aria-label]="deonDownloadAriaLabel(i, d)"
            (click)="$event.stopPropagation()"
            (keydown.enter)="$event.stopPropagation()"
            (keydown.space)="$event.stopPropagation()"
          >
            <img
              class="dl-icon-img"
              src="assets/icons/download.webp"
              alt=""
              width="35"
              height="46"
              loading="lazy"
            />
            <span class="dl-label">{{ deonDownloadLabel(i, d) }}</span>
          </a>
        </div>
      </li>
    </ul>
  </div>
</section>


<!-- ========================= TIMELINE ========================= -->
<section class="section timeline" *ngIf="timeline.length">
  <div class="timeline-bg">
    <div class="timeline-layer"></div>
  </div>

  <div class="section-inner">
    <h2 #tlTitleEl class="timeline-title pb-8 prehide">
            {{ timelineTitle }}
          </h2>

    <div class="tl-grid">
      <span #tlRail class="tl-rail" aria-hidden="true"></span>

      <ng-container *ngFor="let s of timeline; trackBy: trackByIndex">
        <div #tlYearEl class="tl-year prehide">
          {{ s.year }}
        </div>

        <div #tlBodyEl class="tl-body prehide">
          <h2
            class="tl-item-title"
            *ngIf="s.title"
            [innerHTML]="s.title">
          </h2>

          <div
            class="tl-desc"
            *ngIf="s.html"
            [innerHTML]="s.html">
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</section>




  <!-- ===== FAQ (visible / crawlable) — FIN DE PAGE ===== -->
<section class="faq" *ngIf="faqItems.length" aria-labelledby="faq-title">
  <div class="faq-inner px-0 pt-lg-8 pb-lg-8 pt-3 pb-lg-5">
    <h2 id="faq-title" class="faq-title">FAQ</h2>

    <ul class="faq-list" role="list">
      <li class="faq-item" *ngFor="let q of faqItems; let i = index; trackBy: trackByIndex">

        <!-- Ligne question + chevron (cliquable) -->
        <button
          type="button"
          class="faq-qrow"
          (click)="toggleFaqItem(i)"
          [attr.aria-expanded]="isFaqItemOpen(i)"
          [attr.aria-controls]="'faq-a-' + i"
        >
          <span class="faq-q">{{ q.q }}</span>

          <!-- chevron -->
          <svg class="faq-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"/>
          </svg>
        </button>

        <!-- Réponse (on garde le DOM pour SEO/crawl, on masque via CSS) -->
        <div
          class="faq-a"
          [class.is-collapsed]="!isFaqItemOpen(i)"
          [attr.id]="'faq-a-' + i"
          [attr.aria-hidden]="!isFaqItemOpen(i)"
          [innerHTML]="q.a"
        ></div>

      </li>
    </ul>
  </div>
</section>
</div>
